-- SERVICES
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- =========================
-- SETTINGS
-- =========================
local TELEPORT_KEY = Enum.KeyCode.X
local RETURN_DELAY = 1
local OFFSET = CFrame.new(0, 0, -2)
-- =========================

local busy = false

-- get HRP safely
local function getHRP()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart"), char:WaitForChild("Humanoid")
end

-- get closest player to cursor (FIXED)
local function getClosestPlayerToCursor()
    local closest, shortest = nil, math.huge
    local mousePos = UserInputService:GetMouseLocation()
    local inset = GuiService:GetGuiInset()
    mousePos -= inset

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                    if dist < shortest then
                        shortest = dist
                        closest = hrp
                    end
                end
            end
        end
    end

    return closest
end

-- FORCE teleport for 1 frame
local function forceCFrame(hrp, cf)
    RunService:BindToRenderStep("ForceTP", Enum.RenderPriority.Character.Value + 1, function()
