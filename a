-- SERVICES
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- PLAYER
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- =========================
-- ðŸ”§ SETTINGS (CHANGE THESE)
-- =========================
local TELEPORT_KEY = Enum.KeyCode.X
local RETURN_DELAY = 1
local TELEPORT_OFFSET = Vector3.new(0, 0, -2) -- stand slightly in front
-- =========================

local busy = false

-- get character safely
local function getCharacter()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    return char, char:WaitForChild("HumanoidRootPart")
end

-- find closest player to mouse
local function getClosestPlayerToCursor()
    local closestPlayer = nil
    local shortestDistance = math.huge

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local hrp = player.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local mousePos = UserInputService:GetMouseLocation()
                    local distance = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude

                    if distance < shortestDistance then
                        shortestDistance = distance
                        closestPlayer = player
                    end
                end
            end
        end
    end

    return closestPlayer
end

-- teleport logic
local function teleportToPlayerAndBack()
    if busy then return end
    busy = true

    local char, hrp = getCharacter()
    local savedCFrame = hrp.CFrame

    local targetPlayer = getClosestPlayerToCursor()
    if not targetPlayer or not targetPlayer.Character then
        busy = false
        return
    end

    local targetHRP = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not targetHRP then
        busy = false
        return
    end

    -- teleport to target
    hrp.CFrame = targetHRP.CFrame * CFrame.new(TELEPORT_OFFSET)

    -- wait
    task.wait(RETURN_DELAY)

    -- teleport back
    hrp.CFrame = savedCFrame
    busy = false
end

-- keybind listener
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == TELEPORT_KEY then
        teleportToPlayerAndBack()
    end
end)
